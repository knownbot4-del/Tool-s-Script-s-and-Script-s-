import socket
import config
import requests
from concurrent.futures import ThreadPoolExecutor
from VULN_DB import VULN_DB

URL = config.DISCORD_WEBHOOK
numepc = "127.0.0.1"  # Sau IP-ul pe care vrei sa-l scanezi


# --- FUNCTII UTILS ---

def send_msg(text):
    """Trimite notificÄƒri pe Discord"""
    try:
        data = {"content": text}
        requests.post(URL, json=data)
    except Exception as e:
        print(f"Eroare la trimiterea mesajului: {e}")


def check_vulnerabilities(banner_text):
    """VerificÄƒ dacÄƒ bannerul conÈ›ine versiuni vulnerabile"""
    for version, threat in VULN_DB.items():
        # VerificÄƒm dacÄƒ cheia este string (pentru versiuni software)
        if isinstance(version, str) and version in banner_text:
            return f"ğŸš¨ **VULNERABILITATE GÄ‚SITÄ‚:** `{version}`\n> âš ï¸ *AmeninÈ›are:* {threat}"
    return None


# --- LOGICA DE SCANARE ---

def scan_port(port):
    """FuncÈ›ie de scanare per port"""
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.settimeout(1.0)  # Un pic mai mult timp pentru banner grabbing

    try:
        result = s.connect_ex((numepc, port))

        if result == 0:
            msg_vuln = ""
            # VerificÄƒm dacÄƒ portul (int) existÄƒ Ã®n VULN_DB
            if port in VULN_DB:
                info = VULN_DB[port]
                msg_vuln = (f"âš ï¸ **[ VULN DB MATCH ]**\n"
                            f"Port: `{port}` ({info.get('service', 'N/A')})\n"
                            f"Risc: `{info.get('risk', 'UNKNOWN')}`\n"
                            f"Descriere: {info.get('description', '-')}")
                print(f"!!! VULN gasita pe portul {port}")

            print(f"âœ… [+] Portul {port} este DESCHIS.")

            # Banner Grabbing
            banner_text = ""
            try:
                # Trimitem o cerere genericÄƒ pentru a forÈ›a un rÄƒspuns
                s.send(b"Hello\r\n")
                banner = s.recv(1024)
                if banner:
                    banner_text = banner.decode(errors='ignore').strip()
            except:
                banner_text = "N/A"

            # Construim raportul final pentru acest port
            report = f"ğŸ¯ **{numepc}:{port}**\n"
            report += f"âœ… Port DESCHIS"

            if msg_vuln:
                report += f"\n{msg_vuln}"

            if banner_text and banner_text != "N/A":
                report += f"\nğŸ“œ **Banner:** `{banner_text[:100]}`"
                # VerificÄƒm dacÄƒ bannerul are vulnerabilitÄƒÈ›i soft
                vuln_soft = check_vulnerabilities(banner_text)
                if vuln_soft:
                    report += f"\n{vuln_soft}"

            # Trimitem totul pe Discord
            send_msg(report)

    except Exception as e:
        print(f"Eroare la scanarea portului {port}: {e}")
    finally:
        s.close()


# --- MAIN ---

if __name__ == "__main__":
    print(f"ğŸš€ Pornim scanarea TURBO (50 threads) pe {numepc}...")

    with ThreadPoolExecutor(max_workers=50) as executor:
        # ScanÄƒm porturile cele mai comune + cele din VULN_DB
        executor.map(scan_port, range(1, 1025))

    print("ğŸ Gata! Toate porturile au fost verificate.")
